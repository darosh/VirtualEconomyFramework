@using VEDriversLite
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject HttpClient _client
@inject AppData AppData
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@page "/dogeaccount"

<div class="container-fluid">
    <div class="row">
        <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
            <h3>My Doge Account</h3>
        </div>
    </div>

    <VENFTApp_Blazor.Components.DogeAccountBalance />

    <div class="row" style="margin-top:10px;">
        <div class="col d-flex justify-content-center align-items-center">
            <hr />
        </div>
    </div>

    <div class="row" style="margin-bottom:20px;">
        <div class="col">
            <Spin spinning="@sendingTransaction" tip="Sending Transaction...">
                <div class="card" style="margin-top:10px;">
                    <div class="card-header" style="padding-top: 5px;padding-bottom: 5px;">
                        <h5 class="text-center">Send Doge Transaction</h5>
                    </div>
                    <div class="card-body" style="padding: 5px;padding-left: 20px;padding-right: 20px;padding-bottom: 10px;">
                        <div class="row">
                            <div class="col">
                                <div class="row" style="margin-top:10px;">
                                    <div class="col d-flex justify-content-center align-items-center">
                                        <p>To Address:</p>
                                    </div>
                                </div>
                                <div class="row" style="margin-top:10px;">
                                    <div class="col d-flex justify-content-center align-items-center">
                                        <VENFTApp_Blazor.Components.DogeAddressInput AddressCheckedInputed="receiverAddressChangedHandler" />
                                        <!--<VENFTApp_Blazor.Components.LoadQRData MarginLeft="10" ReadedTextChanged="QRTextReaded" />-->
                                    </div>
                                </div>
                                <div class="row" style="margin-top:30px;">
                                    <div class="col d-flex justify-content-center align-items-center">
                                        <p>Amount of Doge:</p>
                                    </div>
                                </div>
                                <div class="row" style="margin-top:10px;">
                                    <div class="col d-flex justify-content-center align-items-center">
                                        <input type="number" step="1" min="1" max="@AppData.DogeAccount.TotalBalance" @bind="@AmountToSend" />
                                    </div>
                                </div>
                                <VENFTApp_Blazor.Components.UploadImage ImageLinkChanged="@ImageLinkChanged" />

                                <div class="row" style="margin-top:20px; margin-bottom:10px;">
                                    <div class="col d-flex justify-content-center align-items-center">
                                        <button class="btn btn-primary" @onclick="SendTx">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </Spin>
        </div>
    </div>

    <div class="row" style="margin-bottom:20px;">
        <div class="col">
            <div class="card" style="margin-top:10px;">
                <div class="card-header" style="padding-top: 5px;padding-bottom: 5px;">
                    <h5 class="text-center">Received Transactions</h5>
                </div>
                <div class="card-body" style="padding: 5px;padding-left: 20px;padding-right: 20px;padding-bottom: 10px;">
                    <div class="row">
                        <div class="col">
                            <table style="width:100%;">
                                <thead style="width:100%;">
                                    <tr>
                                        <th>Date Time</th>
                                        <th>Amount</th>
                                        <th>Confirmations</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody style="width:100%;">
                                    @foreach (var tx in AppData.DogeAccount.ReceivedTransactions)
                                    {
                                        <tr>
                                            <td>@TimeHelpers.UnixTimestampToDateTime(tx.Time * 1000).ToString()</td>
                                            <td>@tx.Value</td>
                                            <td>@tx.Confirmations</td>
                                            <td><button class="btn btn-primary" @onclick="async () => ShowTxDetails(tx.TxId)"><i class="oi oi-info"></i></button></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="margin-bottom:20px;">
        <div class="col">
            <div class="card" style="margin-top:10px;">
                <div class="card-header" style="padding-top: 5px;padding-bottom: 5px;">
                    <h5 class="text-center">Sent Transactions</h5>
                </div>
                <div class="card-body" style="padding: 5px;padding-left: 20px;padding-right: 20px;padding-bottom: 10px;">
                    <div class="row">
                        <div class="col">
                            <table style="width:100%;">
                                <thead style="width:100%;">
                                    <tr>
                                        <th>Date Time</th>
                                        <th>Amount</th>
                                        <th>Confirmations</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody style="width:100%;">
                                    @foreach (var tx in AppData.DogeAccount.SentTransactions)
                                    {
                                        <tr>
                                            <td>@TimeHelpers.UnixTimestampToDateTime(tx.Time * 1000).ToString()</td>
                                            <td>@tx.Value</td>
                                            <td>@tx.Confirmations</td>
                                            <td><button class="btn btn-primary" @onclick="async () => ShowTxDetails(tx.TxId)"><i class="oi oi-info"></i></button></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="margin-bottom:20px;">
        <div class="col">
            <div class="card" style="margin-top:10px;">
                <div class="card-header" style="padding-top: 5px;padding-bottom: 5px;">
                    <h5 class="text-center">Export Account Key</h5>
                </div>
                <div class="card-body" style="padding: 5px;padding-left: 20px;padding-right: 20px;padding-bottom: 10px;">
                    <div class="row">
                        <div class="col">
                            <div class="row" style="margin-top:10px;">
                                <div class="col d-flex justify-content-center align-items-center">
                                    <span class="text-center">Please dont forget to save your private key!!! It is unique key for your Doge address. If you save it you can backup address anytime.</span>
                                </div>
                            </div>
                            <VENFTApp_Blazor.Components.DisplayAccountKey DogeAccountKey="true" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--
    <div class="row" style="margin-bottom:20px;">
        <div class="col">
            <div class="card" style="margin-top:10px;">
                <div class="card-header" style="padding-top: 5px;padding-bottom: 5px;">
                    <h5 class="text-center">Advanced Tools</h5>
                </div>
                <div class="card-body" style="padding: 5px;padding-left: 20px;padding-right: 20px;padding-bottom: 10px; min-height:600px;">
                    <div class="row d-flex justify-content-center align-items-center">
                        <div class="col d-flex justify-content-center align-items-center flex-wrap">
                            <VENFTApp_Blazor.Components.SignAndVerifyMessage />
                            <VENFTApp_Blazor.Components.NeblioPriceStats />
                            <VENFTApp_Blazor.Components.NeblioPriceConversion />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    -->
    <VENFTApp_Blazor.Components.InfoEventModal />
</div>

<Modal Title="Transaction Details"
       Visible="@txDetailsVisible"
       OnOk="@CloseTxDetails"
       OnCancel="@CloseTxDetails">
    <VENFTApp_Blazor.Components.DogeTransactionDetails TxId="@txDetailsTxId" />
</Modal>

@code {

    string txDetailsTxId = string.Empty;
    bool txDetailsVisible = false;

    private bool sendingTransaction = false;
    private double AmountToSend = 1;
    private string receiver = string.Empty;
    private string message = string.Empty;
    public string Receiver
    {
        get => receiver;
        set
        {
            if (!string.IsNullOrEmpty(value))
            {
                receiver = value;
                StateHasChanged();
            }
        }
    }

    protected override Task OnInitializedAsync()
    {
        try
        {
            if (string.IsNullOrEmpty(AppData.DogeAccount.Address))
                Redirect();
            else
                Load();
        }
        catch (Exception ex)
        {
            Redirect();
        }

        return base.OnInitializedAsync();
    }

    void ImageLinkChanged(string newLink)
    {
        message = newLink;
    }

    private async Task CloseTxDetails(MouseEventArgs e)
    {
        txDetailsVisible = false;
    }

    private async Task ShowTxDetails(string txId)
    {
        txDetailsTxId = txId;
        StateHasChanged();
        txDetailsVisible = true;
        StateHasChanged();
    }


    private void receiverAddressChangedHandler(string address)
    {
        if (address.Length < 8)
        {
            Receiver = string.Empty;
            return;
        }
        Receiver = address;
        StateHasChanged();
    }

    private async Task SendTx()
    {
        if (string.IsNullOrEmpty(receiver))
        {
            await JSRuntime.InvokeVoidAsync("alertMessage", "Please Fill Correct Receiver.");
            return;
        }
        try
        {
            sendingTransaction = true;
            StateHasChanged();

            var res = await AppData.DogeAccount.SendPayment(Receiver, AmountToSend, message);
            Console.WriteLine("Tx send result: " + res);
            if (!res.Item1)
            {
                await JSRuntime.InvokeVoidAsync("alertMessage", "Some error during minting: " + res.Item2);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            sendingTransaction = false;
            StateHasChanged();
        }
    }

    private async Task Load()
    {
        if (AppData.DogeAccount != null)
            AppData.DogeAccount.Refreshed += RefreshedHandler;
    }

    void RefreshedHandler(object sender, EventArgs e)
    {
        StateHasChanged();
    }

    private async Task Redirect()
    {
        AppData.DogeAccount = new VEDriversLite.DogeAccount();
        await Task.Delay(500);
        NavManager.NavigateTo("/");
    }
}
