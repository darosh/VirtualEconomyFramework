@using System.IO;
@using VEDriversLite
@using VEDriversLite.NFT
@using VEDriversLite.NeblioAPI
@using Ipfs.Http
@using Tewr.Blazor.FileReader
@inject IFileReaderService fileReaderService
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject AppData AppData
@inject HttpClient _client
@inject NavigationManager NavManager
@page "/nfts"

<div class="container-fluid">


    @if (AppData.Account.IsLocked())
    {
        <Alert Type="@AlertType.Error"
               Message="Error"
               Description="Account Is Locked. Please unlock account first."
               ShowIcon="true" />
    }

    @if (errorDuringSend)
    {
        <Alert Type="@AlertType.Error"
               Message="Error"
               Description=@errorMessage
               ShowIcon="true" />
    }

    <Spin spinning="@sendingTransaction" tip="@sendingTransactionState">
        <div class="row">
            <div class="col">
                <div class="row">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <h1>My NFTs</h1>
                    </div>
                </div>
                <div class="row" style="margin-top:20px;">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <span style="font-size:12px;">Address: <a href="https://explorer.nebl.io/address/@AppData.Account.Address" style="font-size:12px;" target="_blank">@AppData.Account.Address</a></span>
                    </div>
                </div>
                <div class="row" style="margin-top:10px;margin-bottom:2px;">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <span style="font-size:10px;">Actual Balance: @addressInfo.Balance NEBL</span>
                    </div>
                </div>
                <div class="row" style="margin-top:2px;margin-bottom:2px;">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <span style="font-size:10px;">Unconfirmed Balance: @addressInfo.UnconfirmedBalance NEBL</span>
                    </div>
                </div>
                <div class="row" style="margin-top:2px;margin-bottom:2px;">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <span style="font-size:10px;">Source Tokens Balance: @availableTokens VENFT</span>
                    </div>
                </div>
                <div class="row" style="margin-top:2px;margin-bottom:2px;">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <span style="font-size:10px;">NFTs: @addressNFTCount</span>
                    </div>
                </div>
                <div class="row" style="margin-top:20px;">
                    <div class="col d-flex d-xl-flex justify-content-end justify-content-xl-end align-items-xl-end">
                        <button class="btn btn-primary" @onclick="LoadNFTs"><i class="oi oi-reload"></i></button>
                    </div>
                </div>
                <div class="row">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        @if (AppData.Account.NFTs.Count == 0)
                        {
                            <p><em><Spin Tip="Loading...No NFTs found yet"></Spin></em></p>
                        }
                        else
                        {
                            @foreach (var nft in AppData.Account.NFTs)
                            {
                                if (nft.TypeText != "NFT Profile" && nft.TypeText != "NFT Settings")
                                {
                                    <div class="card" style="margin-left:10px; margin-top:10px; max-width:250px; min-width:50px;">
                                        <img class="card-img-top" src="@nft.ImageLink" style="min-height:50px; max-height:250px; height:auto; max-width:250px; min-width:50px; width:auto;" />
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col">
                                                    <div class="row">
                                                        <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                                                            <VENFTApp_Blazor.Components.NFTThumbnail Name="@nft.Name" Type="@nft.Type" Author="@nft.Author" Description="@nft.Description" />
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                                                            <button class="btn btn-primary" @onclick="async () => ShowNFTDetails(nft)" style="margin-top:10px; width: 50px;height: 25px;padding-left: 0px;padding-right: 0px;padding-top: 0px;padding-bottom: 0px;font-size: 12px;"><i class="oi oi-info" style="font-size:12px;"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        }
                    </div>
                </div>

                <div class="row" style="margin-top:20px;">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        Status: <a href="https://explorer.nebl.io/tx/@tokentxid" target="_blank">@tokentxid</a>
                    </div>
                </div>
            </div>
        </div>
    </Spin>
</div>

<Modal Title="@nftInDetails.Name"
       Visible="@nftDetailsVisible"
       OnOk="@CloseNFTDetails"
       OnCancel="@CloseNFTDetails">
    <div class="row">
        <div class="col">
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <span>Name: @nftInDetails.Name</span>
                </div>
            </div>
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <span>Author: @nftInDetails.Author</span>
                </div>
            </div>
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <span>Description: @nftInDetails.Description</span>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(nftInDetails.Link))
            {
                <div class="row">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <a href="@nftInDetails.Link" target="_blank">Connected Link</a>
                    </div>
                </div>
            }
            @if (!string.IsNullOrEmpty(nftInDetails.NFTOriginTxId))
            {
                <div class="row">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <a href="https://explorer.nebl.io/tx/@nftInDetails.NFTOriginTxId" target="_blank">Mint Tx In Explorer</a>
                    </div>
                </div>
            }
            @if (!string.IsNullOrEmpty(nftInDetails.Utxo))
            {
                <div class="row">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <a href="https://explorer.nebl.io/tx/@nftInDetails.Utxo" target="_blank">Tx In Explorer</a>
                    </div>
                </div>
            }
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <span>Confirmations: @nftInDetailsTxInfo.Confirmations.ToString()</span>
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <a href="@nftInDetails.ImageLink" target="_blank">
                        <img src="@nftInDetails.ImageLink" style="min-height:50px; max-height:100px; width:auto;" />
                    </a>
                </div>
            </div>
            @if (nftInDetailsTxInfo.Confirmations > 1)
            {
                @if (nftInDetails.Type == NFTTypes.Post)
                {
                    <div class="row" style="margin-top:20px;">
                        <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                            <button class="btn btn-secondary" @onclick="async () => ShowUpdatePostNFTDialog(nftInDetails)"><i class="oi oi-location"></i> Update</button>
                        </div>
                    </div>
                }
                <div class="row" style="margin-top:20px;">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <button class="btn btn-primary" @onclick="async () => ShowSendNFTDialog(nftInDetails)"><i class="oi oi-location"></i> Send</button>
                    </div>
                </div>
            }
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <hr />
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <button class="btn btn-primary" @onclick="async () => LoadNFTHistory(nftInDetails)"><i class="oi oi-timer"></i> Load NFT History</button>
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <Spin Tip="Loading History..." Spinning="@loadingNFTHistory">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Image</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (nftInDetailsHistory != null)
                                {
                                    @if (nftInDetailsHistory.Count > 0)
                                    {
                                        @foreach (var nft in nftInDetailsHistory)
                                        {
                                            <tr>
                                                <td>@nft.Name</td>
                                                <td>@nft.Description</td>
                                                <td>
                                                    <a href="@nft.ImageLink" target="_blank">
                                                        <img src="@nft.ImageLink" style="min-height:50px; max-height:100px; width:auto;" />
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td>History Not Loaded</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </Spin>
                </div>
            </div>
        </div>
    </div>
</Modal>

<Modal Title="@confirmTitle"
       Visible="@confirmVisible"
       OnOk="@HandleOk"
       OnCancel="@HandleCancel">
    <p>@confirmContent</p>
</Modal>

<Modal Title="Send NFT"
       Visible="@sendNFTDialogVisible"
       OnOk="@sendNFTDialogOK"
       OnCancel="@sendNFTDialogCancel">
    <p>
        <div class="row">
            <div class="col">
                <div class="row">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        Fill Receiver Address:
                    </div>
                </div>
                <div class="row">
                    <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                        <Input Placeholder="Add Name of the NFT" @bind-Value=@receiverAddress Style="font-size:12px; min-width:150px; max-width:250px;" />
                    </div>
                </div>
            </div>
        </div>
    </p>
</Modal>

<Modal Title="Create or edit post NFT"
       Visible="@createNewPostVisible"
       OnOk="@createNewPostConfirm"
       OnCancel="@createNewPostCancel">
    <div class="row">
        <div class="col">

            <div class="row" style="margin-top:10px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <p>Name:</p>
                </div>
            </div>
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <Input Placeholder="Add Name of the post" @bind-Value=@newPostNFT.Name Style="font-size:12px; min-width:250px; max-width:350px;" />
                </div>
            </div>
            <div class="row" style="margin-top:10px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <p>Author:</p>
                </div>
            </div>
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <Input Placeholder="Add Your Name" @bind-Value=@newPostNFT.Author Style="font-size:12px; min-width:250px; max-width:350px;" />
                </div>
            </div>
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <p>Description:</p>
                </div>
            </div>
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <Input Placeholder="Add Text of the post" @bind-Value=@newPostNFT.Description Style="font-size:12px; min-width:250px; max-width:350px;" />
                </div>
            </div>
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <p>Link:</p>
                </div>
            </div>
            <div class="row">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <Input Placeholder="Add any Webpage link" @bind-Value=@newPostNFT.Link Style="font-size:12px; min-width:250px; max-width:350px;" />
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col">
                    <Spin spinning="@uploadingImage" tip="Uploading to IPFS...">
                        <div class="row">
                            <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                                <p>Select and Upload Image:</p>
                            </div>
                        </div>
                        <div class="row" style="margin-top:10px;">
                            <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                                <input type="file" @ref=inputTypeFileElement />
                            </div>
                        </div>
                        <div class="row" style="margin-top:10px;">
                            <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                                <button @onclick=ReadFile>Upload Image</button>
                            </div>
                        </div>
                    </Spin>
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <Input Placeholder="Image Link" @bind-Value=@newPostNFT.ImageLink Style="font-size:12px; min-width:250px; max-width:350px;" />
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <p>Image Preview:</p>
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    @switch (loadingImageStage)
                    {
                        case LoadingImageStages.NotStarted:
                            <p>No image loaded</p>
                            break;
                        case LoadingImageStages.Loading:
                            <Spin Tip="Uploading..." />
                            break;
                        case LoadingImageStages.Loaded:
                            <a href="@newPostNFT.ImageLink" target="_blank"><img src="@newPostNFT.ImageLink" style="max-width:350px; min-width:40px;" alt="Probably still waiting for ipfs confirmation. Wait a minute please..." /></a>
                            break;
                    }
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <p>Status: @tokentxid</p>
                </div>
            </div>
            <div class="row" style="margin-top:20px;">
                <div class="col d-flex d-xl-flex justify-content-center justify-content-xl-center align-items-xl-center">
                    <p>Origin TxId: @newPostNFT.NFTOriginTxId</p>
                </div>
            </div>
        </div>
    </div>
</Modal>

@code {

    bool uploadingImage = false;
    bool processingMinting = false;
    bool errorUpload = false;
    private static int attemptsToDisplay = 10;
    LoadingImageStages loadingImageStage = LoadingImageStages.NotStarted;
    private System.Threading.Timer timer;
    private ElementReference inputTypeFileElement;
    private static readonly IpfsClient ipfs = new IpfsClient("https://ipfs.infura.io:5001");
    PostNFT newPostNFT = new PostNFT("");
    bool createNewPostVisible = false;

    bool sendingTransaction = false;
    string sendingTransactionState = "Sending NFT...";
    bool sendNFTDialogVisible = false;
    bool errorDuringSend = false;
    string errorMessage = string.Empty;

    bool confirmVisible = false;
    string confirmTitle = "Send NFT?";
    string confirmContent = "Do you realy want to send this NFT?";

    string tokentxid = string.Empty;
    string receiverAddress = string.Empty;
    bool nftDetailsVisible = false;
    private INFT nftInDetails = new ImageNFT("");
    string utxoInDetails = string.Empty;

    bool loadingNFTHistory = false;
    List<INFT> nftInDetailsHistory = new List<INFT>();

    private GetAddressResponse addressInfo = new GetAddressResponse();
    private System.Threading.Timer refreshBalanceTimer;
    private int addressNFTCount = 0;
    double availableTokens = 0;

    private GetTransactionInfoResponse nftInDetailsTxInfo = new GetTransactionInfoResponse();
    private System.Threading.Timer nftInDetailsTxInfoRefresh;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            nftInDetailsTxInfo.Confirmations = 0;

            if (string.IsNullOrEmpty(AppData.Account.Address))
            {
                AppData.Account = new NeblioAccount();
                await Task.Delay(500);
                NavManager.NavigateTo("/");
            }
            else
            {
                await LoadNFTs();

                addressInfo = await NeblioTransactionHelpers.AddressInfoAsync(AppData.Account.Address);
                var mintingSupply = await NeblioTransactionHelpers.GetActualMintingSupply(AppData.Account.Address);
                availableTokens = mintingSupply.Item1;
                StateHasChanged(); // MUST CALL StateHasChanged() BECAUSE THIS IS TRIGGERED BY A TIMER INSTEAD OF A USER EVENT
                var nfts = await NeblioTransactionHelpers.GetAddressNFTsUtxos(AppData.Account.Address);
                if (nfts != null)
                    addressNFTCount = nfts.Count;

                refreshBalanceTimer = new System.Threading.Timer(async (object stateInfo) =>
                {
                    addressInfo = await NeblioTransactionHelpers.AddressInfoAsync(AppData.Account.Address);
                    var mintingSupply = await NeblioTransactionHelpers.GetActualMintingSupply(AppData.Account.Address);
                    availableTokens = mintingSupply.Item1;
                    StateHasChanged(); // MUST CALL StateHasChanged() BECAUSE THIS IS TRIGGERED BY A TIMER INSTEAD OF A USER EVENT
                    var nfts = await NeblioTransactionHelpers.GetAddressNFTsUtxos(AppData.Account.Address);
                    if (nfts != null)
                        addressNFTCount = nfts.Count;

                }, new System.Threading.AutoResetEvent(false), 2000, 2000);
            }
        }
        catch(Exception ex)
        {
            AppData.Account = new NeblioAccount();
            await Task.Delay(500);
            NavManager.NavigateTo("/");
        }
    }

    private async Task LoadNFTs()
    {
        var nfts = await NFTHelpers.LoadAddressNFTs(AppData.Account.Address);
        AppData.Account.NFTs = nfts;
    }

    private async Task CloseNFTDetails(MouseEventArgs e)
    {
        nftDetailsVisible = false;
        nftInDetailsTxInfoRefresh.Dispose();
    }

    private async Task ShowNFTDetails(INFT nft)
    {
        nftInDetailsHistory = new List<INFT>();
        nftInDetails = nft;
        nftDetailsVisible = true;

        nftInDetailsTxInfo = await NeblioTransactionHelpers.GetTransactionInfo(nftInDetails.Utxo);
        if (nftInDetailsTxInfo == null)
        {
            nftInDetailsTxInfo = new GetTransactionInfoResponse();
            nftInDetailsTxInfo.Confirmations = 0;
        }

        nftInDetailsTxInfoRefresh = new System.Threading.Timer(async (object stateInfo) =>
        {
            nftInDetailsTxInfo = await NeblioTransactionHelpers.GetTransactionInfo(nftInDetails.Utxo);
            if (nftInDetailsTxInfo == null)
            {
                nftInDetailsTxInfo = new GetTransactionInfoResponse();
                nftInDetailsTxInfo.Confirmations = 0;
            }

        }, new System.Threading.AutoResetEvent(false), 2000, 2000);
    }

    private async Task HandleOk(MouseEventArgs e)
    {
        confirmVisible = false;
        sendNFTDialogVisible = false;
        nftDetailsVisible = false;

        await sendNFT();
    }

    private void HandleCancel(MouseEventArgs e)
    {
        confirmVisible = false;
    }

    private async Task sendNFTDialogOK(MouseEventArgs e)
    {
        confirmVisible = true;
    }

    private void sendNFTDialogCancel(MouseEventArgs e)
    {
        sendNFTDialogVisible = false;
    }

    private async Task ShowSendNFTDialog(INFT nft)
    {
        sendNFTDialogVisible = true;

    }

    private async Task sendNFT()
    {
        errorDuringSend = false;

        if (AppData.Account.IsLocked())
        {
            sendingTransaction = false;
            StateHasChanged();
            return;
        }

        var nutxos = await NeblioTransactionHelpers.GetAddressNeblUtxo(AppData.Account.Address, 0.0001, 0.0002);
        if (nutxos.Count == 0)
        {
            processingMinting = false;
            errorDuringSend = true;
            errorMessage = "You dont have Neblio on the address!";
            StateHasChanged();
            return;
        }


        if (!string.IsNullOrEmpty(nftInDetails.Utxo))
        {
            var utxo = await NeblioTransactionHelpers.ValidateOneTokenNFTUtxo(AppData.Account.Address, nftInDetails.Utxo);
            if (!utxo.Item1)
            {
                processingMinting = false;
                errorDuringSend = true;
                errorMessage = "Provided source tx transaction is not spendable!";
                StateHasChanged();
                return;
            }
        }
        else
        {
            var utxo = await NeblioTransactionHelpers.ValidateOneTokenNFTUtxo(AppData.Account.Address, utxoInDetails);
            if (!utxo.Item1)
            {
                processingMinting = false;
                errorDuringSend = true;
                errorMessage = "Provided source tx transaction is not spendable!";
                StateHasChanged();
                return;
            }
        }

        sendingTransaction = true;
        tokentxid = "Sending...";
        StateHasChanged();

        // create token metadata
        var metadata = new Dictionary<string, string>();
        metadata.Add("NFT", "true");
        switch (nftInDetails.Type)
        {
            case NFTTypes.Image:
                metadata.Add("Type", "NFT Image");
                break;
            case NFTTypes.Post:
                metadata.Add("Type", "NFT Post");
                break;
        }

        if (nftInDetails.Type == NFTTypes.Post)
        {
            metadata.Add("Name", nftInDetails.Name);
            metadata.Add("Author", nftInDetails.Author);
            metadata.Add("Description", nftInDetails.Description);
            metadata.Add("Image", nftInDetails.ImageLink);
            metadata.Add("Link", nftInDetails.Link);
        }

        metadata.Add("SourceUtxo", nftInDetails.NFTOriginTxId);

        // fill input data for sending tx
        var dto = new SendTokenTxData() // please check SendTokenTxData for another properties such as specify source UTXOs
        {
            Amount = 1,
            Id = "La58e9EeXUMx41uyfqk6kgVWAQq9yBs44nuQW8", // id of token
            Symbol = "VENFT", // symbol of token
            Metadata = metadata,
            Password = "", // put here your password,
            sendUtxo = new List<string>() { nftInDetails.Utxo },
            SenderAddress = AppData.Account.Address,
            ReceiverAddress = receiverAddress
        };

        try
        {
            // send tx
            var rtxid = await NeblioTransactionHelpers.SendNTP1TokenAPIAsync(dto, AppData.Account);
            if (rtxid != null)
            {
                sendingTransactionState = "Transaction Send right!";
                tokentxid = rtxid;
                AppData.Account.NFTs.Clear();
                StateHasChanged();
                await LoadNFTs();
                sendingTransaction = false;
                errorMessage = string.Empty;
                errorDuringSend = false;
            }
        }
        catch (Exception ex)
        {
            tokentxid = ex.Message;
            errorDuringSend = true;
            errorMessage = ex.Message;

        }
    }

    private async Task ShowUpdatePostNFTDialog(INFT nft)
    {
        if (nftInDetails != null)
        {
            utxoInDetails = nft.Utxo;
            newPostNFT.Fill(nft);
            loadingImageStage = LoadingImageStages.Loaded;
            await Task.Delay(100);

            createNewPostVisible = true;
            StateHasChanged();
        }
    }

    private async Task LoadNFTHistory(INFT nft)
    {
        loadingNFTHistory = true;
        await Task.Delay(50);
        StateHasChanged();
        nftInDetailsHistory = await NFTHelpers.LoadNFTsHistory(nft.Utxo);
        loadingNFTHistory = false;
        await Task.Delay(50);
        StateHasChanged();
    }

    private async Task createNewPostConfirm(MouseEventArgs e)
    {
        createNewPostVisible = false;
        await MintNewPostNFT();
    }


    private async Task createNewPostCancel(MouseEventArgs e)
    {
        createNewPostVisible = false;
    }

    public async Task ReadFile()
    {
        try
        {
            errorUpload = false;
            uploadingImage = true;
            attemptsToDisplay = 10;
            StateHasChanged();
            foreach (var file in await fileReaderService.CreateReference(inputTypeFileElement).EnumerateFilesAsync())
            {
                loadingImageStage = LoadingImageStages.Loading;
                // Read into buffer and act (uses less memory)
                await using (Stream stream = await file.OpenReadAsync())
                {
                    var fileinfo = await file.ReadFileInfoAsync();

                    try
                    {
                        var imageLink = await NFTHelpers.ipfs.FileSystem.AddAsync(stream, fileinfo.Name);
                        newPostNFT.ImageLink = "https://gateway.ipfs.io/ipfs/" + imageLink.ToLink().Id.ToString();
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine("Error during uploading the image to the IPFS." + ex.Message);
                    }

                    timer = new System.Threading.Timer(async (object stateInfo) =>
                    {
                        try
                        {
                            if (!string.IsNullOrEmpty(newPostNFT.ImageLink))
                            {
                                using var httpResponse = await _client.GetAsync(newPostNFT.ImageLink);

                                if (httpResponse.IsSuccessStatusCode)
                                {
                                    loadingImageStage = LoadingImageStages.Loaded;
                                    uploadingImage = false;

                                    StateHasChanged(); // MUST CALL StateHasChanged() BECAUSE THIS IS TRIGGERED BY A TIMER INSTEAD OF A USER EVENT
                                    timer.Dispose();
                                }

                                attemptsToDisplay--;
                                if (attemptsToDisplay < 0)
                                {
                                    loadingImageStage = LoadingImageStages.Loaded;
                                    uploadingImage = false;
                                    StateHasChanged();
                                    timer.Dispose();
                                }
                            }
                            else
                            {
                                loadingImageStage = LoadingImageStages.NotStarted;
                                uploadingImage = false;
                                errorUpload = true;
                                StateHasChanged();
                                timer.Dispose();
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine("Error during checking uploaded image!" + ex.Message);
                            attemptsToDisplay--;
                            if (attemptsToDisplay < 0)
                            {
                                loadingImageStage = LoadingImageStages.NotStarted;
                                uploadingImage = false;
                                errorUpload = true;
                                StateHasChanged();
                                timer.Dispose();
                            }
                        }
                    }, new System.Threading.AutoResetEvent(false), 4000, 4000);
                }
            }
        }
        catch (Exception ex)
        {
            loadingImageStage = LoadingImageStages.NotStarted;
            uploadingImage = false;
            errorUpload = true;
            StateHasChanged();
        }
    }

    private async Task MintNewPostNFT()
    {

        errorDuringSend = false;

        if (AppData.Account.IsLocked())
        {
            processingMinting = false;
            return;
        }

        var nutxos = await NeblioTransactionHelpers.GetAddressNeblUtxo(AppData.Account.Address, 0.0001, 0.0002);
        if (nutxos.Count == 0)
        {
            processingMinting = false;
            errorDuringSend = true;
            errorMessage = "You dont have Neblio on the address!";
            StateHasChanged();
            return;
        }

        if (!string.IsNullOrEmpty(nftInDetails.Utxo))
        {
            var utxo = await NeblioTransactionHelpers.ValidateOneTokenNFTUtxo(AppData.Account.Address, nftInDetails.Utxo);
            if (!utxo.Item1)
            {
                processingMinting = false;
                errorDuringSend = true;
                errorMessage = "Provided source tx transaction is not spendable!";
                StateHasChanged();
                return;
            }
        }
        else
        {
            var utxo = await NeblioTransactionHelpers.ValidateOneTokenNFTUtxo(AppData.Account.Address, utxoInDetails);
            if (!utxo.Item1)
            {
                processingMinting = false;
                errorDuringSend = true;
                errorMessage = "Provided source tx transaction is not spendable!";
                StateHasChanged();
                return;
            }
        }

        sendingTransaction = true;
        processingMinting = true;
        StateHasChanged();

        try
        {
            string rtxid = string.Empty;

            var utxo = string.Empty;
            if (string.IsNullOrEmpty(nftInDetails.Utxo))
                utxo = nftInDetails.Utxo;
            else
                utxo = utxoInDetails;

            rtxid = await NFTHelpers.ChangePostNFT(AppData.Account, newPostNFT, utxo);

            if (!string.IsNullOrEmpty(rtxid))
            {
                tokentxid = rtxid;

                await Task.Delay(1000);
                processingMinting = false;

                var nfts = await NFTHelpers.LoadAddressNFTs(AppData.Account.Address);
                AppData.Account.NFTs = nfts;

            }

            if (rtxid != null)
                tokentxid = rtxid;

            nftDetailsVisible = false;
            sendingTransaction = false;
            createNewPostVisible = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            createNewPostVisible = false;
            nftDetailsVisible = false;
            sendingTransaction = false;
            tokentxid = ex.Message;
            errorDuringSend = true;
            errorMessage = ex.Message;
            StateHasChanged();
        }
    }
}
